<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Torneo Americano</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { margin: 5px; }
    .hidden { display: none; }
    pre { background: #f0f0f0; padding: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h2>Ingreso de jugadores</h2>
<div id="ingreso">
  <div id="jugadores"></div>
  <button onclick="comenzarTorneo()">Comenzar Torneo</button>
  <hr>
  <input type="file" id="archivoTorneo" accept=".json">
  <button onclick="cargarTorneo()">Cargar torneo desde archivo</button>
</div>

<div id="ronda" class="hidden">
  <h2 id="rondaTitulo"></h2>
  <div id="partidos"></div>
  <button onclick="guardarResultados()">Guardar resultados</button>
  <button onclick="descargarTorneo()">Guardar torneo como archivo</button>
</div>

<div id="ranking" class="hidden">
  <h2>Ranking Final</h2>
  <pre id="tablaFinal"></pre>

  <h3>Resultados por ronda</h3>
  <pre id="resumenFinal"></pre>

  <button onclick="descargarTorneo()">Guardar torneo como archivo</button>
</div>

<script>
let jugadores = [];
let rondas = [];
let rondaActual = 0;
let rankingFinal = [];

function crearCampos() {
  const cont = document.getElementById("jugadores");
  cont.innerHTML = "";
  for (let i = 0; i < 8; i++) {
    const input = document.createElement("input");
    input.placeholder = `Jugador ${i + 1}`;
    input.id = `j${i}`;
    cont.appendChild(input);
  }
}
window.onload = crearCampos;

function comenzarTorneo() {
  jugadores = [];
  for (let i = 0; i < 8; i++) {
    const nombre = document.getElementById(`j${i}`).value.trim();
    if (!nombre) return alert("Todos los jugadores deben tener nombre");
    jugadores.push({ nombre });
  }

  // Mezclar jugadores al azar
  jugadores.sort(() => Math.random() - 0.5);

  generarRondas();
  mostrarRonda();
}

function generarRondas() {
  const J = jugadores.map(j => j.nombre);
  rondas = [
    [
      { cancha: "Sur", pareja1: [J[7], J[6]], pareja2: [J[5], J[2]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[1], J[0]], pareja2: [J[3], J[4]], score1: null, score2: null }
    ],
    [
      { cancha: "Sur", pareja1: [J[3], J[6]], pareja2: [J[7], J[4]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[2], J[1]], pareja2: [J[5], J[0]], score1: null, score2: null }
    ],
    [
      { cancha: "Sur", pareja1: [J[7], J[2]], pareja2: [J[4], J[1]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[3], J[0]], pareja2: [J[6], J[5]], score1: null, score2: null }
    ],
    [
      { cancha: "Sur", pareja1: [J[4], J[6]], pareja2: [J[1], J[5]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[0], J[2]], pareja2: [J[3], J[7]], score1: null, score2: null }
    ],
    [
      { cancha: "Sur", pareja1: [J[0], J[4]], pareja2: [J[2], J[6]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[5], J[7]], pareja2: [J[1], J[3]], score1: null, score2: null }
    ],
    [
      { cancha: "Sur", pareja1: [J[2], J[3]], pareja2: [J[6], J[1]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[4], J[5]], pareja2: [J[7], J[0]], score1: null, score2: null }
    ],
    [
      { cancha: "Sur", pareja1: [J[3], J[5]], pareja2: [J[4], J[2]], score1: null, score2: null },
      { cancha: "Norte", pareja1: [J[1], J[7]], pareja2: [J[0], J[6]], score1: null, score2: null }
    ]
  ];
}

function mostrarRonda() {
  document.getElementById("ingreso").classList.add("hidden");
  document.getElementById("ronda").classList.remove("hidden");
  document.getElementById("ranking").classList.add("hidden");
  document.getElementById("rondaTitulo").innerText = `Ronda ${rondaActual + 1}`;
  const cont = document.getElementById("partidos");
  cont.innerHTML = "";
  rondas[rondaActual].forEach((p, i) => {
    const div = document.createElement("div");
    div.innerHTML = `
      <strong>Cancha ${p.cancha}</strong><br>
      ${p.pareja1.join(" y ")} vs ${p.pareja2.join(" y ")}<br>
      <input id="s${i}a" type="number" placeholder="Pareja 1" min="0">
      <input id="s${i}b" type="number" placeholder="Pareja 2" min="0"><br><br>
    `;
    cont.appendChild(div);
  });
}

function guardarResultados() {
  const ronda = rondas[rondaActual];
  ronda.forEach((p, i) => {
    const s1 = parseInt(document.getElementById(`s${i}a`).value);
    const s2 = parseInt(document.getElementById(`s${i}b`).value);
    if (isNaN(s1) || isNaN(s2)) return alert("Ingresá todos los resultados");
    p.score1 = s1;
    p.score2 = s2;
  });

  rondaActual++;
  if (rondaActual < rondas.length) {
    mostrarRonda();
  } else {
    mostrarRanking();
    mostrarResumenResultados();
  }
}

function mostrarRanking() {
  document.getElementById("ronda").classList.add("hidden");
  document.getElementById("ranking").classList.remove("hidden");

  const tabla = {};
  jugadores.forEach(j => tabla[j.nombre] = { puntos: 0, contra: 0 });

  rondas.forEach(ronda => {
    ronda.forEach(p => {
      p.pareja1.forEach(j => {
        tabla[j].puntos += p.score1;
        tabla[j].contra += p.score2;
      });
      p.pareja2.forEach(j => {
        tabla[j].puntos += p.score2;
        tabla[j].contra += p.score1;
      });
    });
  });

  const ordenados = Object.entries(tabla).sort((a, b) =>
    b[1].puntos - a[1].puntos || a[1].contra - b[1].contra
  );

  rankingFinal = ordenados.map(([nombre]) => nombre);

  let texto = "Posición | Jugador       | Puntos | Pts. en contra\n";
  texto += "---------|---------------|--------|----------------\n";
  ordenados.forEach(([nombre, stats], i) => {
    texto += `${i + 1}`.padEnd(9) + "| " + nombre.padEnd(13) + "| " +
             `${stats.puntos}`.padStart(6) + " | " + `${stats.contra}`.padStart(14) + "\n";
  });
  document.getElementById("tablaFinal").innerText = texto;
}
function mostrarResumenResultados() {
  let texto = "";
  rondas.forEach((ronda, index) => {
    texto += `Ronda ${index + 1}:\n`;
    ronda.forEach(partido => {
      texto += `  Cancha ${partido.cancha}: ${partido.pareja1.join(" y ")} vs ${partido.pareja2.join(" y ")} → ${partido.score1}-${partido.score2}\n`;
    });
    texto += "\n";
  });

  // Ronda extra basada en ranking final
  if (rankingFinal.length === 8) {
    texto += "Ronda Extra:\n";
    texto += `  Cancha Norte: ${rankingFinal[0]} y ${rankingFinal[3]} vs ${rankingFinal[1]} y ${rankingFinal[2]}\n`;
    texto += `  Cancha Sur: ${rankingFinal[4]} y ${rankingFinal[7]} vs ${rankingFinal[5]} y ${rankingFinal[6]}\n`;
  }

  document.getElementById("resumenFinal").innerText = texto;
}

function descargarTorneo() {
  const estado = {
    jugadores: jugadores.map(j => ({ nombre: j.nombre })),
    rondas,
    rondaActual
  };
  const blob = new Blob([JSON.stringify(estado, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "torneo_padel.json";
  a.click();
  URL.revokeObjectURL(url);
}

function cargarTorneo() {
  const input = document.getElementById("archivoTorneo");
  const file = input.files[0];
  if (!file) return alert("Seleccioná un archivo .json");

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = JSON.parse(e.target.result);
    jugadores = data.jugadores;
    rondas = data.rondas;
    rondaActual = data.rondaActual;

    if (rondaActual < rondas.length) {
      mostrarRonda();
    } else {
      mostrarRanking();
      mostrarResumenResultados();
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>